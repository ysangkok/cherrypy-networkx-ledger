<!doctype html>
<html ng-app="myApp">
<head>
<link rel="stylesheet" type="text/css" href="/temp/ownproj/intro.js-0.5.0/introjs.css">
<script src="/temp/ownproj/intro.js-0.5.0/intro.js"></script>
<script src="/temp/ownproj/angular.js"></script>
<script src="/temp/ownproj/angular-resource.js"></script>
<script src="/temp/ownproj/angular-sanitize.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>ledger</title>
<base href="/temp/ownproj/">
<script>
function errHandler(data, status, $location){
    //alert(status + ": " + data);
    var sourceWindow = window.open('', 'Error', 'height=600,width=800,scrollbars=1,resizable=1');
    sourceWindow.document.write(data);
    sourceWindow.document.close();
}

var module = angular.module('myApp', ['ngSanitize']);

module.config([
  '$routeProvider', '$locationProvider' , function ($routeProvider, $locationProvider) {
     $routeProvider
       .when('/', {redirectTo : '/root/newledger'})
       .when('/root/newledger', {template : '<ng-include src="\'/root/newledger\'"></ng-view>', controller: LedgeController})
       .when('/root/ledgers/:ledgerid/:version', {template : '<ng-include src="\'/root/ledgers/n\'"></ng-view>', controller: ViewLedgerController})
       .when('/404', {template: '<h1>404: {{problem}}<br><a target="_self" href="/temp/ownproj{{fix.url}}">{{fix.desc}}</a></h1>', controller: function($scope,$location) {$scope.problem = $location.search().requested + " not found"; $scope.fix={"url":$location.search().requested,"desc": "try again"}}})
       .otherwise({redirectTo: function(routeParam, path, search){ return '/404?requested=' + path; }});
     ;

     $locationProvider.html5Mode(true);
  }
]);

function ViewLedgerController($scope , $routeParams, $http, $location) {
    $http.get(prefix + "graph/" + $routeParams.ledgerid + "/" + $routeParams.version).success(function(data, status) {
        $scope.graph = data.graph;
        $scope.description = data.description;
    }).error(function(data, status) {
        var currenturl = $location.path();
        console.log(currenturl);
        if (status === 404) $location.path("/404?requested=" + encodeURIComponent(currenturl));
        else errHandler.apply(this, arguments);
    });
    $scope.pairs = pairs;
    $scope.hideMeM = function(v) {return pairs(v).filter(function(w) { return w[1] !== 0 && w[0] !== "$$hashKey"; }).length > 0; };
}

function pairs(foo) {
    if (typeof foo === "undefined") return [];
    if (typeof foo !== 'object') throw new Error("no object: " + JSON.stringify(foo));
//    return Object.keys(arr).map(function(v) { console.log(v); return [v, arr[v]]; });
var noo = [];
for(i in foo)
    if (foo.hasOwnProperty(i)) {
        noo.push([i, foo[i]])
    }
return noo;
}

function LedgeController($scope, $http, $location) {
  $scope.people = [{name: "John Doe"},{name: "Mr Smith"}];
 
  var nameExists = function(t) { return $scope.people.filter(function(v) { return v.name === t; }).length > 0;}

  $scope.addPerson = function() {
    var el = document.querySelector("#personname");
    if (el.value === "") return;
    if (nameExists(el.value)) {alert("Name already used."); return;}
    $scope.people.push({name: el.value });
    el.value = "";
  };

  $scope.hideMe = function() { return $scope.people.length > 0; };
  $scope.hideNoExpenses = function() { return $scope.expenses.length > 0; };

  $scope.addExpense = function() {
      $scope.expenses.push({"whopaid": [], "whoshouldpay": []});
  };
  $scope.expenses = [];
  $scope.submit = function() {
    var names = $scope.people.map(function(v) { return v.name; });
    var expenses = children.filter(function(f) { return !f.hidden; }).map(function(v, idx) {
        if (Object.keys(v.ispayer).map(function(k){ return v.ispayer[k]; }).indexOf(true) === -1) {
            alert("Somebody has to pay! Check one of the checkboxes in the expense with missing payers.");
            throw new Error("validation error");
        }
        //v.ispayer, v.amounts
        var expense = {};
        expense["whoshouldpay"] = Array.range(0,$scope.people.length).filter(function(value, index) { return v.ispayer[index]; });
        expense["whopaid"] = Array.range(0,$scope.people.length).map(function(w, index) {return {"personId": index, "amount": Number(v.amounts[index] || 0)};}).filter(function(v) { return v["amount"] !== 0; });
        expense["description"] = v.descs[idx] ? v.descs[idx] : "Unnamed Expense";
        return expense;
    });
    if ([].concat.apply([],  // concatenate all whopaid arrays
          expenses.map(function(v) { return v.whopaid}) // get whopaid arrays
        )
        .filter(function(v){return v.amount !== 0; }) // get the ones where an amount was entered
        .length === 0 // test if no amounts were entered
       ) { alert("No expenses yet! Somebody must have bought something for an amount, and people should be assigned to pay for it (checkboxes)"); return; }
    var d = document.querySelector("#ledgerdesc").value ? document.querySelector("#ledgerdesc").value : "Unnamed Ledger";
    var obj = {people: names, expenses: expenses, description: d};
    console.log("POSTing", JSON.stringify(obj));
    $http.post(prefix + 'expenses', obj).success(function(data, status, headers, config) {
        //$location.path(data);
        $location.path("/root/ledgers/" + data.jobid + "/" + data.version);
    }).error(errHandler.bind(this));
  };

  var children = [];
  $scope.childAdd = function(child) {
    children.push(child);
  };

  $scope.edit = function(idx) {
    var t;
    t = prompt("Enter new name");
    if (!t) return;
    if (nameExists(t)) {alert("Name already used."); return;}
    $scope.people[idx].name = t;
  }

  $scope.addExpense();
}
var prefix = "/temp/ownproj/rest/";
Array.range= function(a, b, step){
    var A= [];
        A[0]= a;
        step= step || 1;
        while(a+step< b){
            A[A.length]= a+= step;
        }
    return A;
}

function clone(obj) {
    // Handle the 3 simple types, and null or undefined
    if (null == obj || "object" != typeof obj) return obj;

    // Handle Date
    if (obj instanceof Date) {
        var copy = new Date();
        copy.setTime(obj.getTime());
        return copy;
    }

    // Handle Array
    if (obj instanceof Array) {
        var copy = [];
        for (var i = 0, len = obj.length; i < len; i++) {
            copy[i] = clone(obj[i]);
        }
        return copy;
    }

    // Handle Object
    if (obj instanceof Object) {
        var copy = {};
        for (var attr in obj) {
            if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
        }
        return copy;
    }

    throw new Error("Unable to copy obj! Its type isn't supported.");
}

function ExpenseController($scope) {

    $scope.hidden = false;

    $scope.addPayer = function() {
        this.whopaid.push({"personId": 0, "amount": 0});
    };
    $scope.whoshouldpay = function(expense) {
        return $scope.$parent.people.filter(function(v) { return v.shouldpay; }).map(function(v) { return v.personId; });
    };
    $scope.people = function() { return clone($scope.$parent.people); };

    $scope.$parent.childAdd($scope);

    $scope.ispayer = {};
    $scope.hideMe = function() { return $scope.people().length > 0; };
    $scope.amounts = {};
    $scope.descs = {};

    $scope.deleteMe = function (v) {
        //$scope.$parent.expenses.splice(v, 1);
        $scope.hidden = true;
    };

}

</script>
</head>
<body>
<script type="text/ng-template"  id="/root/newledger">
<h1>New Ledger</h1>
<div><button onclick="startIntro()">Tutorial</button></div>
<label>Ledger description: <input placeholder="Camping trip" id="ledgerdesc" /></label>
<fieldset>
    <legend>People</legend>
    <div>
        <ul class="step2">
            <li ng-hide="hideMe()">No people added yet</li>
            <li class="step0" ng-repeat="person in people">{{person.name}} <a href="javascript:void(0)" ng-click="edit($index)" style="opacity:0.4">âœŽ</a></li>
        </ul>
        <form ng-submit="addPerson()">
          <div class="step1">
            <input placeholder="Name" id="personname" />
            <input type="submit" value="Add" />
          </div>
        </form>
    </div>
</fieldset>

        <div>
            <div ng-repeat="expense in expenses">
              <div ng-hide="hidden" ng-controller="ExpenseController">
                <fieldset>
                <legend>Expense {{$index+1}}: {{descs[$index]}}</legend>
                <label>Expense description: <input placeholder="Beer" ng-model="descs[$index]" /></label>
                <table cellpadding="5">
                    <thead ng-show="hideMe()"><tr><th>Name of payer<th>Should this person actually pay for this item?<th>Amount paid already</tr></thead>
                    <tr ng-repeat="person in people()">
                        <td class="step3">{{person.name}}</td>
                        <td class="step5"><input type="checkbox" ng-model="ispayer[$index]" style="width:100%" /></td>
                        <td class="step4"><!--ng-show="ispayer[$index]"-->
                            <input ng-model="amounts[$index]" placeholder="0" style="text-align:right" />
                        </td>
                    </tr>
                    <tr><td colspan="3" ng-hide="hideMe()">No people added yet</td></tr>
                </table>
                <button ng-click="deleteMe($index)">Delete expense</button>
                </fieldset>
              </div>
            </div>
            <div ng-hide="hideNoExpenses()">No expenses yet</div>
            <div class="step3">
                <button ng-click="addExpense()">Add Expense</button>
            </div>
        </div>
<p><button class="step6" ng-click="submit()">Submit</button></p>
</script>

<div ng-view></div>
<script type="text/ng-template"  id="/root/ledgers/n">
<p><a href="root/newledger">New ledger</a></p>
<h1>Viewing ledger: {{description}}</h1>
<div ng-repeat="(k,v) in graph">
<h2>{{k}}</h2>
<div ng-hide="hideMeM(v)">doesn't have to give out anything</div>
<div ng-repeat="(i,j) in v" ng-show="j">
give {{i}} {{j}}.
</div>
</div>
</script>
<script type="text/javascript">
function startIntro() {
  var intro = introJs();
  intro.setOptions({
    steps: [
      { element: document.querySelectorAll('.step0')[0], intro: "These are sample people involved in this ledger, you can edit their names." },
      { element: document.querySelectorAll('.step1')[0], intro: "If you need more people, add them here." },
      { element: document.querySelectorAll(".step2")[0], intro: 'Everyone you add are visible in this list.', },
      { element: document.querySelectorAll(".step3")[0], intro: "When you are done adding people, add a new expense."},
      { element: document.querySelectorAll(".step4")[0], intro: "You can specify how much they contributed to each expense (like purchases).", },
      { element: document.querySelectorAll(".step5")[0], intro: 'You can also specify whether they should be reimbursed fully, or if they should contribute to paying the expense. Remember, somebody has to pay! That means, at least one checkbox has to get checked!' },
      { element: document.querySelectorAll(".step6")[0], intro: "When you have added all expenses, click Submit to calculate how much everyone should pay each other."}
    ]
  });

  intro.start();
}
</script>
</body>
</html>
